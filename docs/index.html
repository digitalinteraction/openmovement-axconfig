<!doctype html><html lang="en" UNUSED_manifest="cache.appcache"><head><meta charset="utf-8"><title>AX Configure</title><link rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;," _href="icon.ico"><style type="text/css">body,html{height:100%;width:100%}html{font-family:sans-serif;background:#f5f5f5}body{margin:0;display:grid;grid-template-rows:auto fit-content(35vh)}.main{overflow:auto;margin:.5em}fieldset{max-width:40em;margin:.5em auto}#warnings,.main_button,h1{text-align:center}#output::-webkit-scrollbar{width:.5em}#output::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3)}#output::-webkit-scrollbar-thumb{background-color:#a9a9a9;outline:1px solid #708090}#output{box-shadow:inset 4px 4px 10px #aaa;background:#fff;color:#000;margin-top:1em;font-family:monospace;overflow-y:auto;padding:.3em 0 .3em .3em;border-radius:4px;height:35vh;display:none}body.console #output{display:block}#output p{font-size:14px;font-weight:700;padding:.2em;margin:0}#output p:nth-child(odd){background:linear-gradient(180deg,rgba(51,238,238,.13),rgba(51,238,238,.13) 50%,rgba(51,153,153,.13) 0,rgba(51,153,85,.13));background-size:100% 2px}.button{box-shadow:inset 0 1px 0 0 #bbdaf7;background:linear-gradient(180deg,#79bbff 5%,#378de5);background-color:#79bbff;border-radius:6px;border:1px solid #84bbf3;display:inline-block;cursor:pointer;color:#fff;font-size:15px;padding:10px 20px;text-decoration:none;text-shadow:0 1px 0 #528ecc}.button:hover{background:linear-gradient(180deg,#378de5 5%,#79bbff);background-color:#378de5}.button:active{position:relative;top:2px}.button:disabled{background:#ddd;cursor:not-allowed}.button:disabled:hover{background:#ddd}.button:disabled:active{top:0}fieldset,form{margin-bottom:6pt}fieldset{border-radius:6pt}fieldset div{display:flex;vertical-align:bottom;margin-top:.2em;margin-bottom:.2em}fieldset label{margin-left:.5em;width:6em}fieldset input[type=datetime-local],fieldset input[type=number],fieldset input[type=text],fieldset meter,fieldset output,fieldset select{width:6.6em;flex-grow:1}#code{font-size:150%}fieldset #battery{flex-grow:1;margin-left:.5em}summary{font-size:small;cursor:pointer}summary:after{content:"..."}.version,footer div{font-size:small;color:#777}footer{margin-top:1em}footer div{color:#333;text-align:center}footer a{color:#777;text-decoration:none}footer a:active,footer a:hover{text-decoration:underline}.disconnected{display:block}.connected,.connected-valid,.device-connected .disconnected{display:none}.device-connected .connected,.device-connected.config-valid .connected-valid,.incomplete{display:block}.complete,.completed .incomplete{display:none}.completed .complete{display:block}#duration_days,#duration_hours,#duration_minutes,#duration_seconds{text-align:right}</style><link rel="manifest" href="manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="application-name" content="AX Config"><meta name="apple-mobile-web-app-title" content="AX Config"><meta name="msapplication-starturl" content="/"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><script __not__type="module">parcelRequire=function(e,t,o,n){var s,r="function"==typeof parcelRequire&&parcelRequire,i="function"==typeof require&&require;function a(o,n){if(!t[o]){if(!e[o]){var s="function"==typeof parcelRequire&&parcelRequire;if(!n&&s)return s(o,!0);if(r)return r(o,!0);if(i&&"string"==typeof o)return i(o);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}u.resolve=function(t){return e[o][1][t]||t},u.cache={};var c=t[o]=new a.Module(o);e[o][0].call(c.exports,u,c,c.exports,this)}return t[o].exports;function u(e){return a(u.resolve(e))}}a.isParcelRequire=!0,a.Module=function(e){this.id=e,this.bundle=a,this.exports={}},a.modules=e,a.cache=t,a.parent=r,a.register=function(t,o){e[t]=[function(e,t){t.exports=o},{}]};for(var l=0;l<o.length;l++)try{a(o[l])}catch(e){s||(s=e)}if(o.length){var c=a(o[o.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=c:"function"==typeof define&&define.amd&&define(function(){return c})}if(parcelRequire=a,s)throw s;return a}({x7XL:[function(e,t,o){"use strict";function n(e){if("object"!=typeof e)return null;const t=60*(new Date).getTimezoneOffset()*1e3;return new Date(e.getTime()-t)}Object.defineProperty(o,"__esModule",{value:!0}),o.sleep=async function(e){return new Promise(t=>setTimeout(t,e))},o.localTime=n,o.localTimeString=function(e,t){const o=n(e);if(null===o)return null;const s=o.toISOString().slice(0,-1);return t?s.slice(0,-7):s},o.localTimeValue=function(e){if("string"!=typeof e||0===e.length)return null;16==e.length&&(e+=":00"),19==e.length&&(e+=".000"),23==e.length&&(e+="Z");const t=60*(new Date).getTimezoneOffset()*1e3;return new Date(new Date(e).getTime()+t)},o.watchParameters=function(e){function t(){const t=new URL(window.location.href),o=t.searchParams,n=new URLSearchParams(t.hash.replace(/^#/,"")),s=[];for(let e of[o,n])for(let t of e.entries())s.push(t);const r={};for(let e of s)r[e[0].toLowerCase()]=e[1];e(r,s)}window.onhashchange=t,t()},o.redirectConsole=function(e,t="P"){function o(e,o,...n){const s=document.querySelector(e),r=n.join(" ");if(!s)return"[pre-DOM] "+r;const i=document.createTextNode(r),a=document.createElement(t);return a.appendChild(i),s.appendChild(a),a.scrollIntoView(!1),r}for(let t of["log","warn","error"]){const n=console[t];console[t]=function(){const s=o(e,t,...arguments);n(s)}}}},{}],yzmp:[function(e,t,o){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;o.default=class{constructor(e){this.inputSelector=e,this.inputBuffer="",this.timeoutId=null}start(e=null,t=null){this.changeCallback=e,document.onkeydown=this.keydown.bind(this);const o=()=>{const t=document.querySelector(this.inputSelector);if(e){const o=t.value;e(o)}},n=document.querySelector(this.inputSelector);n.addEventListener("input",o),n.addEventListener("change",o),n.addEventListener("focus",function(){this.select()}),n.form.onsubmit=e=>{const o=document.querySelector(this.inputSelector);if(e.preventDefault(),o.blur(),!o.form.querySelector("input[type=submit]").disabled&&t){const e=o.value;t(e)}return!1},o()}setValue(e,t=!1){this.inputBuffer="";const o=document.querySelector(this.inputSelector);if(o){if(arguments.length>0&&(console.log("KEYINPUT: "+e),o.value=e),o.dispatchEvent(new Event("change",{bubbles:!0})),t){const e=o.form.querySelector('input[type="submit"]');e&&e.click()}}else console.log("KEYINPUT: Error: element not found: "+this.inputSelector)}submitEnabled(e){document.querySelector(this.inputSelector).form.querySelector("input[type=submit]").disabled=!e}keydown(e){let t=!0;e=e||window.event,this.inputSelector||(t=!1),document.activeElement&&("INPUT"==document.activeElement.tagName&&["text","password","date","email","number","search"].indexOf(document.activeElement.type)>=0&&(t=!1),"TEXTAREA"==document.activeElement.tagName&&(t=!1)),(e.altKey||e.ctrlKey)&&(t=!1),e.which<32&&(this.inputBuffer.length>0&&13==e.which&&(e.preventDefault(),this.setValue(this.inputBuffer,!0)),t=!1),e.key&&1==e.key.length||(t=!1),null!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),t?(e.preventDefault(),this.inputBuffer+=e.key,this.timeoutId=setTimeout(function(){this.inputBuffer=""}.bind(this),2e3)):this.inputBuffer=""}}},{}],anNG:[function(e,t,o){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;const n=new TextEncoder("windows-1252"),s=new TextDecoder("windows-1252"),r=2,i=10;function a(e){let t=null,o=null;for(let n of e.interfaces)n.alternates[0].interfaceClass==r?t=n.interfaceNumber:n.alternates[0].interfaceClass==i&&(o=n.interfaceNumber);if(null===t)return console.log("WARNING: CDC control interface not found in configuration "+e.configurationValue),null;null===o&&(console.log("NOTE: CDC data interface not found in configuration "+e.configurationValue+" -- will continue and assume malformed CDC using a single interface"),o=t);let n=null;for(let o of e.interfaces[t].alternates[0].endpoints)"in"===o.direction&&"interrupt"===o.type&&(n=o.endpointNumber);if(null===n)return console.log("WARNING: CDC control endpoint not found in configuration "+e.configurationValue),null;let s=null,a=null;for(let r of e.interfaces[o].alternates[0].endpoints)o==t&&r.endpointNumber==n||("in"===r.direction&&"bulk"===r.type?s=r.endpointNumber:"out"===r.direction&&"bulk"===r.type?a=r.endpointNumber:console.log("NOTE: Data endpoint ignored "+r.endpointNumber));return null===s||null===a?(console.log("WARNING: CDC data read/write endpoints not found in configuration "+e.configurationValue),null):{configurationValue:e.configurationValue,control:{interface:t,endpoint:n},data:{interface:o,endpointRead:s,endpointWrite:a}}}function l(e){let t=null;for(let o of e.interfaces)255==o.alternates[0].interfaceClass&&(t=o.interfaceNumber);if(null===t)return null;let o=null,n=null;for(let s of e.interfaces[t].alternates[0].endpoints)"in"===s.direction&&"bulk"===s.type&&(o=s.endpointNumber),"out"===s.direction&&"bulk"===s.type&&(n=s.endpointNumber);return null===o||null===n?(console.log("WARNING: Generic data read/write endpoints not found in configuration "+e.configurationValue),null):{configurationValue:e.configurationValue,data:{interface:t,endpointRead:o,endpointWrite:n}}}o.default=class{constructor(e){this.device=e,this.type="usb",this.productName=this.device.productName,this.manufacturerName=this.device.manufacturerName,this.serialNumber=this.device.serialNumber,this.io=null}async open(){try{await this.device.open()}catch(e){throw console.log("ERROR: Problem opening device: "+e,e.name+" -- "+e.message),"file:"==location.protocol&&console.log("NOTE: Hosting from a file: protocol may cause this. Try serving over HTTP."),"SecurityError"==e.name&&navigator.appVersion.indexOf("(Windows")>=0&&console.log('NOTE: The "new" Windows WebUSB back-end may have this issue.'),e}console.log("Determine I/O..."),this.io=null;for(let e of this.device.configurations){if(this.io=l(e),null!==this.io)break;if(this.io=a(e),null!==this.io)break}if(null===this.io)throw console.log("ERROR: No matching configuration found."),"No matching configuration found";console.log("IO FOUND, selecting configuration: "+JSON.stringify(this.io));try{await this.device.selectConfiguration(this.io.configurationValue)}catch(e){throw console.log("ERROR: Problem selecting configuration: "+this.io.configurationValue+" -- "+e),e}console.log("...claiming interfaces...");try{await this.device.claimInterface(this.io.data.interface)}catch(e){throw console.log("ERROR: Problem claiming data interface (could it already be claimed by a driver?): "+this.io.data.interface+" -- "+e),"Could not claim interface (could it already be claimed by a driver?): "+this.io.data.interface+" -- "+e}console.log("...USB opened")}async close(){try{await this.device.releaseInterface(this.io.data.interface)}catch(e){console.log("WARNING: Problem releasing data interface: "+this.io.data.interface+" -- "+e)}finally{try{return console.log("...close..."),await this.device.close(),console.log("...closed"),!0}catch(e){return console.log("WARNING: Problem closing device -- "+e),!1}}}async write(e){console.log("SEND: "+e.replace(/[\r\n]/g,"|"));let t=n.encode(e);console.log("===: "+t);try{await this.device.transferOut(this.io.data.endpointWrite,t)}catch(e){throw console.log("WARNING: Problem writing data: "+this.io.data.endpointWrite+" -- "+t+" -- "+e),e}}async read(){console.log("Read...");let e=null;try{console.log(`...transferIn(${this.io.data.endpointRead})`);let t=await this.device.transferIn(this.io.data.endpointRead,64);if(console.log(`...transferIn() - done (${t.status}): `+t),"stall"===t.status&&(console.log("Endpoint stalled. Clearing."),await this.device.clearHalt("in",this.io.data.endpointRead)),"ok"===t.status)if(t.data&&t.data.byteLength>0){let o=0;for(let e=0;e<t.data.byteLength;e++){let e=t.data.getUint8();(e>=128||e<32&&"\r"!=e&&"\n"!=e)&&(buffer.setUint8(32),o++)}o>0&&console.log(`NOTE: Replaced ${o} of ${t.data.byteLength} bytes.`),e=s.decode(t.data)}else console.log("WARNING: Transfer was ok but no data: "+t.data.byteLength);else console.log("WARNING: Transfer result: "+t.status)}catch(e){return console.log("WARNING: Problem reading data: "+this.io.data.endpointRead+" -- "+e),null}return console.log("RECV: "+(null===e?"<null>":e.replace(/[\r\n]/g,"|"))),e}async cancelRead(){try{return console.log("cancelRead() - "+this.io.data.endpointRead),await this.device.clearHalt("in",this.io.data.endpointRead),console.log("cancelRead() - done"),!0}catch(e){return console.log("WARNING: Problem cancelling read: "+this.io.data.endpointRead+" -- "+e),!1}}isBusy(){return this.device.opened}}},{}],Lo8Z:[function(e,t,o){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;e("./util.mjs");o.default=class{constructor(e){console.dir(e),this.port=e,this.type="serial",console.log("PORT: "+JSON.stringify(this.port)),console.log("PORT properties: "+JSON.stringify(Object.getOwnPropertyNames(this.port))),this.portInfo={},this.port.getInfo?this.portInfo=this.port.getInfo():console.log("WARNING: No .portInfo()"),console.log("PORT INFO: "+JSON.stringify(this.portInfo)),this.productName=this.portInfo.product,this.manufacturerName=this.portInfo.manufacturer,this.serialNumber=this.portInfo.serialNumber,this.openFlag=!1,this.unopenable=!1,this.buffer=[]}internalStartRead(){try{this.reader.read().then(this.internalRead.bind(this))}catch(e){console.log("ERROR: Problem in reader while starting read -- reader may be broken now: "+e)}}internalRead({done:e,value:t}){try{if(console.log("*** "+JSON.stringify({value:t,done:e})),null!=t&&t.length>0&&(console.log("<<< ["+this.buffer.length+"] "+t),this.buffer.push(t)),e)return console.log("READER: Stream end"),this.reader.releaseLock(),void(this.reader=null)}catch(e){console.log("ERROR: Problem in reader while completing read -- reader may be broken now: "+e)}setTimeout(this.internalStartRead.bind(this),0)}async open(){try{if(this.openFlag)throw"Port already open";const e={baudrate:9600};await this.port.open(e),this.encoder=new TextEncoderStream,this.outputDone=this.encoder.readable.pipeTo(this.port.writable),this.outputStream=this.encoder.writable,this.writer=null,this.decoder=new TextDecoderStream,this.inputDone=this.port.readable.pipeTo(this.decoder.writable),this.inputStream=this.decoder.readable,this.reader=this.inputStream.getReader(),this.internalStartRead(),this.openFlag=!0,this.unopenable=!1}catch(e){throw this.unopenable=!0,console.log("ERROR: Problem opening serial device: "+e,e.name+" -- "+e.message),e}console.log("...serial opened")}async close(){try{console.log("CLOSE: reader="+(this.reader?JSON.stringify(this.reader):"n/a"));try{this.reader&&await this.reader.cancel()}catch(e){console.log("ERROR: Problem cancelling reader: "+e)}try{await this.inputDone.catch(()=>{})}catch(e){console.log("ERROR: Problem waiting for inputDone: "+e)}this.port.readable.locked&&(console.log("!!! UNEXPECTED: Port readable was still locked -- expected to be released when stream flagged done."),this.reader&&this.reader.releaseLock()),this.reader=null;try{await this.outputStream.getWriter().close(),this.outputStream=null}catch(e){console.log("ERROR: Problem closing writer: "+e)}try{await this.outputDone,this.outputDone=null}catch(e){console.log("ERROR: Problem waiting for outputDone: "+e)}}catch(e){console.log("WARNING: Problem cancelling/unlocking: "+e)}finally{try{return console.log("...close..."),this.port.writable.locked&&console.error("WARNING: Port writable is still locked (will not close)."),await this.port.close(),console.log("...closed"),this.openFlag=!1,!0}catch(e){return console.log("WARNING: Problem closing port -- "+e),!1}}}async write(e){console.log("SEND: "+e.replace(/[\r\n]/g,"|"));try{this.writer&&console.log("UNEXPECTED: Writer already exists"),this.writer=this.outputStream.getWriter(),await this.writer.write(e)}catch(e){throw console.log("WARNING: Problem writing data: "+e),e}finally{this.writer&&(this.writer.releaseLock(),this.writer=null)}}async read(){console.log("Read... "+this.buffer.length);let e=null;try{for(;this.buffer.length>0;)null===e&&(e=""),e+=this.buffer.shift()}catch(e){return console.log("WARNING: Problem reading serial data: "+e),null}return console.log("RECV: "+(null===e?"<null>":e.replace(/[\r\n]/g,"|"))),e}async cancelRead(){}isBusy(){return!1}}},{"./util.mjs":"x7XL"}],sLgq:[function(e,t,o){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;var n=e("./util.mjs");class s{constructor(e,t,o){this.output=e,this.prefix=t,this.timeout=o}isTerminal(e){return!(!this.prefix&&""!==this.prefix||!e.startsWith(this.prefix))}}class r{constructor(e){this.started=(new Date).getTime(),this.command=e,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t}),this.lines=[],this.completed=!1,this.error=null}addResponse(e){this.lines.push(e);const t=this.command.isTerminal(e);return console.log(`...now have ${this.lines.length} line(s) (terminal=${t})`),!!t}lastLine(){return this.completed&&this.lines.length>0?this.lines[this.lines.length-1]:null}complete(e=null){null!=e?(console.log("COMMAND-REJECT: "+e),this.error=e,this.reject(this)):(console.log("COMMAND-RESOLVE"),this.completed=!0,this.resolve(this))}checkTimeout(){const e=(new Date).getTime()-this.started;return!(this.completed||this.error||!this.command.timeout||!(e>=this.command.timeout))}}class i{constructor(e){if(this.device=e,console.log("--- COMMS ---"),console.log(this.device.productName),console.log(this.device.manufacturerName),console.log(this.device.serialNumber),this.serial=function(e){if(null==e)return null;if(!(e=e.trim()).startsWith("AX")&&!e.startsWith("CWA"))return null;for(let t=e.length-1;;t--)if(t<0||!(e.charCodeAt(t)>=48&&e.charCodeAt(t)<=57))return t+1>=e.length?null:parseInt(e.substring(t+1))}(this.device.serialNumber),console.log("SERIAL: "+this.serial),this.deviceType=null,this.device.serialNumber){const e=this.device.serialNumber.trim();e.startsWith("CWA")?this.deviceType="AX3":e.startsWith("AX")&&(this.deviceType=e.substring(0,3))}this.hasGyro="AX6"===this.deviceType,this.commandQueue=[],this.currentCommand=null,this.currentTimeout=null,this.nextTick=null,this.receiveBuffer="",this.statusHandler=null,this.status={id:{deviceId:null},battery:{percent:null,time:null},start:null,stop:null,state:null,errorState:null},this.recalculateRecordingStatus()}setStatusHandler(e){this.statusHandler=e}statusChanged(){this.statusHandler&&this.statusHandler(this,this.status)}updateState(e,t){console.log("STATE: "+e+" / "+t),this.status.state=e,this.status.errorState=t,this.statusChanged()}async exec(e){console.log("exec()");const t=new r(e);return this.commandQueue.push(t),null==this.currentCommand&&null==this.nextTick&&(console.log("exec(): bootstrap"),this.nextTick=setTimeout(async()=>{console.log("exec(): bootstrap..."),await this.execNext(),console.log("exec(): bootstrap... done")},0)),console.log("exec(): return"),t.promise}async execNext(){if(console.log("execNext()"),null==this.currentCommand){if(console.log("execNext(): no command..."),this.commandQueue.length<=0)return console.log("execNext(): no more commands"),void(this.nextTick=null);console.log("execNext(): getting next command..."),this.currentCommand=this.commandQueue.shift(),this.currentCommand.command.timeout?(console.log("execNext(): setting up new timeout: "+this.currentCommand.command.timeout),this.currentTimeout=setTimeout(this.timeout.bind(this),this.currentCommand.command.timeout)):console.log("execNext(): command has no timeout");try{console.log("execNext(): write: "+this.currentCommand.command.output.replace(/[\r\n]/g,"|")),await this.write(this.currentCommand.command.output),console.log("execNext(): write: (done)")}catch(e){console.log("execNext(): write: exception: "+e),this.commandComplete(e)}}if(this.currentCommand){let e=null;try{this.currentCommand&&this.currentCommand.checkTimeout()&&(console.log("execNext(): timeout"),this.commandComplete("Timeout before read")),console.log("execNext(): read"),e=await this.read()}catch(e){console.log("execNext(): read exception: "+e),this.commandComplete(e)}if(null===e&&"serial"===this.device.type&&null===e&&(await this.write("\r\n"),await(0,n.sleep)(100)),this.currentCommand&&null!==e)for(console.log("execNext(): adding data "+e.length),this.receiveBuffer+=e;;){const e=this.receiveBuffer.indexOf("\n");if(e<0)break;const t=this.receiveBuffer.slice(0,e).trim();if(console.log("LINE: "+t),this.receiveBuffer=this.receiveBuffer.slice(e+1),this.currentCommand.addResponse(t)){console.log("execNext(): end"),this.commandComplete();break}}else console.log("execNext(): (no command or no data) ")}this.nextTick=setTimeout(async()=>{console.log("execNext(): ..."),await this.execNext(),console.log("execNext(): ... done")},0),console.log("execNext(): end")}async timeout(){try{console.log("timeout(): ..."),this.currentTimeout=null,this.currentCommand?(console.log("timeout(): ...cancel..."),await this.device.cancelRead(),this.commandComplete("Timeout")):console.log("timeout(): no current command"),console.log("timeout(): ...done")}catch(e){console.log("timeout(): ERROR: "+e)}}commandComplete(e=null){null!==e?console.log("commandComplete(): FAILED "+e+" -- "+(this.currentCommand?this.currentCommand.command.output:"-")):console.log("commandComplete(): SUCCESS -- "+(this.currentCommand?this.currentCommand.command.output:"-")),this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),this.currentCommand&&this.currentCommand.complete(e),this.currentCommand=null}async open(){this.receiveBuffer="",await this.device.open(),console.log("...opened")}async close(){return await this.device.close()}async write(e){await this.device.write(e)}async read(){return await this.device.read()}parseDateTime(e){if("0"==e)return 0;if("-1"==e)return-1;const t=parseInt(e.substring(0,4),10),o=parseInt(e.substring(5,7),10),n=parseInt(e.substring(8,10),10),s=parseInt(e.substring(11,13),10),r=parseInt(e.substring(14,16),10),i=parseInt(e.substring(17,19),10),a=new Date(t,o-1,n,s,r,i,0);return a.getFullYear()<2e3?0:a.getFullYear()>=2064?-1:a}packDateTime(e=null){if(null===e&&(e=new Date),0==e)return"0";if(-1==e)return"-1";let t=e.getFullYear()+"/";return(t=(t=(t=(t=t+(e.getMonth()+1<10?"0":"")+(e.getMonth()+1)+"/")+(e.getDate()<10?"0":"")+e.getDate()+",")+(e.getHours()<10?"0":"")+e.getHours()+":")+(e.getMinutes()<10?"0":"")+e.getMinutes()+":")+(e.getSeconds()<10?"0":"")+e.getSeconds()}async getConfigOptions(){return{accelRate:[6.25,12.5,25,50,100,200,400,800,1600,3200],accelRange:[2,4,8,16]}}async getId(){const e=new s("\r\nID\r\n","ID=",2e3);console.log(">>> "+e.output);const t=(await this.exec(e)).lastLine();console.log("<<< "+t);const o=t.substring(t.indexOf("=")+1).split(",");return this.hasGyro="AX6"===o[0],{deviceType:"CWA"==o[0]?"AX3":o[0],deviceId:parseInt(o[3],10),firmwareVersion:parseInt(o[2],10)}}async getBattery(){const e=new s("\r\nSAMPLE 1\r\n","$BATT=",2e3);console.log(">>> "+e.output);const t=(await this.exec(e)).lastLine();console.log("<<< "+t);const o=t.substring(t.indexOf("=")+1).split(",").map(e=>parseInt(e,10));return{voltage:o[1]/1e3,percent:o[3],charging:o[4],time:new Date}}async setLed(e){const t=new s(`\r\nLED ${e}\r\n`,"LED=",2e3);console.log(">>> "+t.output);const o=(await this.exec(t)).lastLine();console.log("<<< "+o);const n=o.substring(o.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(n[0]!=e)throw`LED value unexpected: was ${n[0]}, expected ${e}`}async setTime(e=null){this.updateState("Setting time");let t=e;null===t&&(t=new Date);const o=this.packDateTime(t),n=new s(`\r\nTIME ${o}\r\n`,"$TIME=",2e3);console.log(">>> "+n.output);const r=(await this.exec(n)).lastLine();console.log("<<< "+r);const i=this.parseDateTime(r.substring(r.indexOf("=")+1)),a=i.getTime()-t.getTime();if(Math.abs(a)>2e3)throw`Time value difference too large: received ${i.toISOString()}, expected closer to ${t.toISOString()}`}async setSession(e){const t=parseInt(e);if(this.updateState("Setting session ID"),"number"!=typeof t||isNaN(t)||t<0||t>2147483647)throw"Session ID invalid value";const o=new s(`\r\nSESSION ${t}\r\n`,"SESSION=",2e3);console.log(">>> "+o.output);const n=(await this.exec(o)).lastLine();console.log("<<< "+n);const r=n.substring(n.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(r[0]!=t)throw`SESSION value unexpected: was ${r[0]}, expected ${t}`}async setMaxSamples(e){this.updateState("Setting max samples");const t=new s(`\r\nMAXSAMPLES ${e}\r\n`,"MAXSAMPLES=",2e3);console.log(">>> "+t.output);const o=(await this.exec(t)).lastLine();console.log("<<< "+o);const n=o.substring(o.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(n[0]!=e)throw`MAXSAMPLES value unexpected: was ${n[0]}, expected ${e}`}async getHibernate(e){const t=new s("\r\nHIBERNATE\r\n","HIBERNATE=",2e3);console.log(">>> "+t.output);const o=(await this.exec(t)).lastLine();console.log("<<< "+o);const n=o.substring(o.indexOf("=")+1);return this.parseDateTime(n)}async setHibernate(e){this.updateState("Setting start");const t=this.packDateTime(e),o=new s(`\r\nHIBERNATE ${t}\r\n`,"HIBERNATE=",2e3);console.log(">>> "+o.output);const n=(await this.exec(o)).lastLine();console.log("<<< "+n);const r=n.substring(n.indexOf("=")+1);if(t!=r)throw`HIBERNATE value unexpected: was ${r}, expected ${t}`}async getStop(e){const t=new s("\r\nSTOP\r\n","STOP=",2e3);console.log(">>> "+t.output);const o=(await this.exec(t)).lastLine();console.log("<<< "+o);const n=o.substring(o.indexOf("=")+1);return this.parseDateTime(n)}async setStop(e){this.updateState("Setting stop");const t=this.packDateTime(e),o=new s(`\r\nSTOP ${t}\r\n`,"STOP=",2e3);console.log(">>> "+o.output);const n=(await this.exec(o)).lastLine();console.log("<<< "+n);const r=n.substring(n.indexOf("=")+1);if(r.indexOf(t)<0)throw`STOP value unexpected: was ${r}, expected ${t}`}async setRate(e,t,o){this.updateState("Setting rate");let n=0;switch(parseFloat(e)){case 3200:n|=15;break;case 1600:n|=14;break;case 800:n|=13;break;case 400:n|=12;break;case 200:n|=11;break;case 100:n|=10;break;case 50:n|=9;break;case 25:n|=8;break;case 12.5:case 12:n|=7;break;case 6.25:case 6:n|=6;break;default:throw"Invalid accelerometer frequency."}if(this.hasGyro&&parseFloat(e)>1600)throw"This device has a maximum rate of 1600Hz";if(this.hasGyro&&parseFloat(e)<25)throw"This device has a minimum rate of 25Hz";switch(parseInt(t)){case 16:n|=0;break;case 8:n|=64;break;case 4:n|=128;break;case 2:n|=192;break;default:throw"Invalid accelerometer sensitivity."}let r=null;if(o){if(!this.hasGyro)throw"Cannot configure gyroscope on device without gyroscope.";switch(parseInt(o)){case 2e3:case 1e3:case 500:case 250:r=parseInt(o);break;default:throw"Invalid gyro range: "+parseInt(o)}}const i=new s(r?`\r\nRATE ${n},${r}\r\n`:`\r\nRATE ${n}\r\n`,"RATE=",2e3);console.log(">>> "+i.output);const a=(await this.exec(i)).lastLine();console.log("<<< "+a);const l=a.substring(a.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(l[0]!=n)throw`RATE value unexpected: was ${l[0]}, expected ${n}`;if(l[1]!=e)throw`RATE frequency unexpected: was ${l[1]}, expected ${e}`;if(r&&l[2]!=r)throw`RATE gyro range unexpected: was ${l[2]}, expected ${r}`}async setDebug(e){let t=!0===e?3:+e;this.updateState("Setting debug status");const o=new s(`\rDEBUG ${t}\r\n`,"DEBUG=",2e3);console.log(">>> "+o.output);const n=(await this.exec(o)).lastLine();console.log("<<< "+n);const r=n.substring(n.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(r[0]!=t)throw`DEBUG value unexpected: was ${r[0]}, expected ${t}`}async readSector(e){const t=new s(`\r\nREADL ${e}\r\n`,"OK",1e4);console.log(">>> "+t.output);const o=await this.exec(t),n=new DataView(new ArrayBuffer(512),0);let r=0;for(let e of o.lines){if(e.startsWith("READL="))continue;if(e.startsWith("OK"))continue;const t=e.split(":",1),o=parseInt(t,16);if(o!=r)throw`Unexpected sector offset ${o}, expected ${r}`;const s=e.trim().slice(t.length+1,-16).replace(/\ /g,""),i=s.length/2;if(16!=i)throw`Unexpected sector line length ${s.length} -> ${i}, expected 32 -> 16`;for(let e=0;e<i;e++){const t=parseInt(s.slice(2*e,2*e+2),16);n.setUint8(t),r++}}if(512!=r)throw`Unexpected sector size ${r}, expected 512`;return n}async readFilesystem(){this.updateState("Reading filesystem");const e={};e.mbrSector=await this.readSector(0),e.firstSectorNumber=e.mbrSector.getUint32(454,!0),e.bootSector=await this.readSector(e.firstSectorNumber),e.sectorsPerCluster=e.bootSector.getUint16(12,!0),e.numReservedSectors=e.bootSector.getUint16(14,!0),e.numFATs=e.bootSector.getUint8(16),e.numRootDirectoryEntries=e.bootSector.getUint16(17,!0),e.sectorsPerFAT=e.bootSector.getUint16(22,!0),e.rootSectorNumber=e.firstSectorNumber+e.numReservedSectors+e.numFATs*e.sectorsPerFAT,e.rootSector=await this.readSector(e.rootSectorNumber),e.firstSectorOfFileArea=e.rootSectorNumber+Math.floor(32*e.numRootDirectoryEntries/512),e.dataLength=null;for(let t=0;t<16;t++){const o=32*t,n="CWA-DATACWA";let s=!0;for(let t=0;t<n.length;t++)if(e.rootSector.getUint8(o+t)!=n.charCodeAt(t)){s=!1;break}if(s){e.dataLength=e.rootSector.getUint32(o+28,!0);break}}return{firstSectorNumber:firstSectorNumber,sectorsPerCluster:sectorsPerCluster,numReservedSectors:numReservedSectors,numFATs:numFATs,numRootDirectoryEntries:numRootDirectoryEntries,sectorsPerFAT:sectorsPerFAT,rootSectorNumber:rootSectorNumber,firstSectorOfFileArea:firstSectorOfFileArea,dataLength:dataLength}}async setMetadata(e){for(let t=0;t<14;t++){this.updateState(`Setting metadata (${t+1} / 14)`);let o="";const n=32*t;let r=32*(t+1);n<e.length&&(r>e.length&&(r=e.length),o=e.substring(n,r));const i="Annotate"+(t<10?"0":"")+t+"="+o+"\r\n",a="ANNOTATE"+(t<10?"0":"")+t+"=";await this.tryAndRetry(async()=>{const e=new s(`\r\n${i}\r\n`,a,1e3);console.log(">>> "+e.output+"|");const t=(await this.exec(e)).lastLine();console.log("<<< "+t);const n=t.substring(t.indexOf("=")+1);if(n.trim()!=o.trim())throw`${a} unexpected value, received "${n.trim()}", expected "${o.trim()}"`})}}async commit(e){let t;if(!0===e)this.updateState("Wipe and commit"),t=new s("\r\nFORMAT WC\r\n","COMMIT",1e4);else if(!1===e)this.updateState("Erase and commit"),t=new s("\r\nFORMAT QC\r\n","COMMIT",8e3);else{if(null!==e)throw"ERROR: Unknown commit type.";this.updateState("Committing"),t=new s("\r\nCommit\r\n","COMMIT",5e3)}console.log(">>> "+t.output);const o=(await this.exec(t)).lastLine();console.log("<<< "+o)}async tryAndRetry(e,t=3,o=1e3){let s="Unexpected failure in retry logic.";for(let r=0;r<t;r++)try{return o&&r>0&&(console.log(`Retrying in ${o/1e3}s...`),await(0,n.sleep)(o)),await e()}catch(e){s=e,console.log(`WARNING: Failed attempt (${r+1}/${t}): `+(e.error?e.error:e))}throw s}async updateStatus(){if(this.device.isBusy())throw this.updateState(null,"Device busy"),"ERROR: Device is busy";try{if(this.updateState("Querying status"),await this.tryAndRetry(()=>this.open()),null===this.status.id||null===this.status.id.deviceId){if(this.status.id=await this.tryAndRetry(()=>this.getId()),this.status.id.deviceId!=this.serial){if(null!==this.serial||"serial"!==this.device.type)throw`ERROR: Device id mismatch: reported ID=${this.status.id.deviceId} but serial number was ${this.serial}.`;console.log(`WARNING: Serial API did not return serial number, so not verifying reported: ID=${this.status.id.deviceId}`)}console.log("ID="+JSON.stringify(this.status.id))}const e=new Date;return(null===this.status.battery||null===this.status.battery.percent||null===this.status.battery.time||e.getTime()-this.status.battery.time.getTime()>=3e4)&&(this.status.battery=await this.tryAndRetry(()=>this.getBattery()),console.log("BATTERY="+JSON.stringify(this.status.battery))),null===this.status.start&&(this.status.start=await this.tryAndRetry(()=>this.getHibernate())),null===this.status.stop&&(this.status.stop=await this.tryAndRetry(()=>this.getStop())),this.recalculateRecordingStatus(),this.status}catch(e){throw e.error?(this.updateState(null,`Error getting status: ${e.error}`),console.log("ERROR: Problem during status update: "+e.error)):(this.updateState(null,`Error getting status: ${e}`),console.log("ERROR: Problem during status update: "+e)),e}finally{await this.close()}}recalculateRecordingStatus(e=!1){const t=Date.UTC(-271821,3,20),o=Date.UTC(275760,8,13),s=(0,n.localTime)(new Date);let r=this.status.start;-1===r&&(r=o),0===r&&(r=t);let i=this.status.stop;-1===i&&(r=o),0===i&&(r=t),this.status.recordingConfigured=r<i,this.status.recordingFinished=this.status.recordingConfigured&&s>=i,this.status.recordingStarted=this.status.recordingConfigured&&s>=r&&!this.status.recordingFinished,this.status.recordingIncomplete=this.status.recordingConfigured&&!this.status.recordingFinished;let a=e?"Configured: ":"";this.status.recordingConfigured?this.status.recordingFinished?a+="Recording complete":this.status.recordingStarted?a+="Recording started":a+="Configured":a=e?"Settings cleared":"Ready",this.updateState(a)}async configure(e){if(this.device.isBusy())throw this.updateState(null,"Device busy"),"ERROR: Device is busy";try{this.updateState("Configuring..."),await this.tryAndRetry(()=>this.open());const t={minBattery:null,configLed:i.LED_BLUE,time:null,session:0,maxSamples:0,rate:100,range:8,gyro:0,start:-1,stop:0,metadata:"",led:i.LED_MAGENTA,wipe:!0,noData:!1,debug:!1};for(let o of Object.keys(e))if(!(o in t))throw`ERROR: Unknown configuration value: ${o}`;const o=Object.assign(t,e);if(console.log("ID="+JSON.stringify(this.status.id)),this.status.id.deviceId!=this.serial){if(null!==this.serial||"serial"!==this.device.type)throw`ERROR: Device id mismatch (was status updated first?): reported ID=${this.status.id.deviceId} but USB serial number was ${this.serial}.`;console.log(`WARNING: Serial API did not return serial number, so not verifying reported: ID=${this.status.id.deviceId}`)}if(await this.tryAndRetry(()=>this.setLed(o.configLed)),console.log("BATTERY="+JSON.stringify(this.status.battery)),this.status.battery.percent<o.minBattery)throw`ERROR: Device battery level too low: ${this.status.battery.percent}% (required ${o.minBattery}%).`;if(o.noData){const e=await this.tryAndRetry(()=>this.readFilesystem());if(console.log("FILESYSTEM="+JSON.stringify(e)),e.dataLength&&e.dataLength>1024)throw"ERROR: Device has data on it."}return o.time||(o.time=new Date),await this.tryAndRetry(()=>this.setTime(o.time)),await this.tryAndRetry(()=>this.setRate(o.rate,o.range,o.gyro)),await this.tryAndRetry(()=>this.setSession(o.session)),await this.tryAndRetry(()=>this.setMaxSamples(o.maxSamples)),await this.tryAndRetry(()=>this.setDebug(o.debug?3:0)),await this.tryAndRetry(()=>this.setHibernate(o.start)),await this.tryAndRetry(()=>this.setStop(o.stop)),await this.tryAndRetry(()=>this.setMetadata(o.metadata)),await this.tryAndRetry(()=>this.commit(o.wipe)),this.status.start=o.start,this.status.stop=o.stop,this.recalculateRecordingStatus(!0),await this.tryAndRetry(()=>this.setLed(o.led)),{time:o.time,deviceId:this.status.id.deviceId,battery:battery.percent,start:o.start,stop:o.stop,session:o.session,rate:o.rate,range:o.range,gyro:o.gyro,metadata:o.metadata}}catch(e){throw e.error?(this.updateState(null,`Error: ${e.error}`),console.log("ERROR: Problem during configuration: "+e.error)):(this.updateState(null,`Error: ${e}`),console.log("ERROR: Problem during configuration: "+e)),e}finally{await this.close()}}}o.default=i,i.USB_DEVICE_VID=1240,i.USB_DEVICE_PID=87,i.LED_OFF=0,i.LED_BLUE=1,i.LED_GREEN=2,i.LED_CYAN=3,i.LED_RED=4,i.LED_MAGENTA=5,i.LED_YELLOW=6,i.LED_WHITE=7},{"./util.mjs":"x7XL"}],bqdr:[function(e,t,o){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=void 0;var n=i(e("./usb_device.mjs")),s=i(e("./serial_device.mjs")),r=i(e("./ax3device.mjs"));function i(e){return e&&e.__esModule?e:{default:e}}o.default=class{constructor(e,t){this.enableSerial=t,this.usbDevices={},this.serialDevices={},this.warnings=[],"file:"===location.protocol&&this.warnings.push("WARNING: Features may not work over the file: protocol (try via a web server)."),"https:"!==location.protocol&&this.warnings.push("WARNING: Features require secure HTTPS."),navigator.usb||navigator.serial||this.warnings.push("WARNING: This browser configuration does not support device connection (WebUSB or Web Serial API)."),!(e&&navigator.usb&&navigator.appVersion.indexOf("(Windows")>=0)||t&&navigator.serial||this.warnings.push("WARNING: WebUSB will not work on Windows as standard (CDC devices claimed by the driver). "+(t?" You can try enabling the experimental Web Serial API at: chrome://flags#enable-experimental-web-platform-features":""));for(let e of this.warnings)console.log(e)}async startup(e){return this.changedHandler=e,navigator.usb&&(navigator.usb.addEventListener("disconnect",e=>{const t=e.device;console.log("DEVICEMANAGER: USB Disconnect "+t);const o=this.usbDevices[t];delete this.usbDevices[t],this.changedHandler&&this.changedHandler(o,t,"disconnect")}),navigator.usb.addEventListener("connect",e=>{const t=e.device;console.log("DEVICEMANAGER: USB Connect "+t);const o=new r.default(new n.default(t));this.usbDevices[t]=o,this.changedHandler&&this.changedHandler(o,t,"connect")})),await this.refreshDevices(),!0}async refreshDevices(){if(navigator.serial){const e={};if(navigator.serial.getPorts){let t=[];try{t=await navigator.serial.getPorts()}catch(e){this.firstSerialEnumerateError||(this.firstSerialEnumerateError=!0,console.log("ERROR: Problem enumerating serial devices: "+e+" -- "+JSON.stringify(e)))}for(let o of t)if(e[o]=o,!(o in this.serialDevices)){console.log("DEVICEMANAGER: Serial Enumerate "+o);const e=new r.default(new s.default(o));this.serialDevices[o]=e,this.changedHandler&&this.changedHandler(e,o,"get")}}for(let t of Object.keys(this.serialDevices))if(!(t in e)){console.log("DEVICEMANAGER: Serial Enumerate device lost "+t);const e=this.serialDevices[t];this.changedHandler&&this.changedHandler(e,t,"disconnect"),delete this.serialDevices[t]}}}async userAddUsbDevice(){if(!navigator.usb)throw"ERROR: WebUSB is not supported in this browser configuration.";try{const e=await navigator.usb.requestDevice({filters:[{vendorId:r.default.USB_DEVICE_VID,productId:r.default.USB_DEVICE_PID}]});if(console.log("DEVICEMANAGER: Request USB "+e),!(e in this.usbDevices)){const t=new r.default(new n.default(e));this.usbDevices[e]=t}return this.changedHandler&&this.changedHandler(this.usbDevices[e],e,"request"),!0}catch(e){throw"NotFoundError"==e.name?(console.log("NOTE: User did not select a device: "+e.name+" -- "+e.message),"No device chosen."):(console.log("ERROR: "+e+" -- "+e.name+" -- "+e.message),"ERROR: "+e+" -- "+e.name+" -- "+e.message)}}async userAddSerialDevice(){if(!("serial"in navigator))throw"ERROR: Web Serial API is not supported in this browser configuration.";try{const e=await navigator.serial.requestPort({filters:[{vendorId:r.default.USB_DEVICE_VID,productId:r.default.USB_DEVICE_PID}]});if(console.log("DEVICEMANAGER: Request serial "+e),!(e in this.serialDevices)){const t=new r.default(new s.default(e));this.serialDevices[e]=t}return this.changedHandler&&this.changedHandler(this.serialDevices[e],e,"request"),!0}catch(e){throw"NotFoundError"==e.name?(console.log("NOTE: User did not select a device: "+e.name+" -- "+e.message),"No device chosen."):(console.log("ERROR: "+e+" -- "+e.name+" -- "+e.message),"ERROR: "+e+" -- "+e.name+" -- "+e.message)}}getSingleDevice(){const e=Object.keys(this.usbDevices).length+Object.keys(this.serialDevices).length;return 1!==e?(console.log("ERROR: DeviceManager has "+e+" device(s) -- this will only work for a single device."),null):Object.keys(this.usbDevices).length>0?Object.values(this.usbDevices)[0]:Object.keys(this.serialDevices).length>0?Object.values(this.serialDevices)[0]:null}}},{"./usb_device.mjs":"anNG","./serial_device.mjs":"Lo8Z","./ax3device.mjs":"sLgq"}],jOUA:[function(e,t,o){"use strict";var n=e("./util.mjs"),s=i(e("./key_input.mjs")),r=i(e("./device_manager.mjs"));function i(e){return e&&e.__esModule?e:{default:e}}window.addEventListener("error",function(e){return document.getElementById("warnings").appendChild(document.createTextNode("⚠️ Unhandled error.")),console.log("ERROR: Unhandled error: "+(e.error&&e.error.message?e.error.message:e.error)),console.log(JSON.stringify(e)),!1}),window.addEventListener("unhandledrejection",function(e){return document.getElementById("warnings").appendChild(document.createTextNode("⚠️ Unhandled promise rejection.")),console.log("ERROR: Unhandled rejection: "+(e.error&&e.error.message?e.error.message:e.error)),console.log(JSON.stringify(e)),!1});let a={},l=!1,c=!1,u=!0,d=!0,h=!1;function g(){h||((0,n.redirectConsole)("#output"),h=!0),c&&document.querySelector("body").classList.toggle("console",l)}(0,n.watchParameters)(v),l&&g(),"serviceWorker"in navigator&&window.addEventListener("load",async function(){try{const e="service-worker.js",t=await navigator.serviceWorker.register(e);t.onupdatefound=function(){const e=t.installing;e.onstatechange=function(){switch(e.state){case"installed":navigator.serviceWorker.controller?(console.log("SERVICEWORKER: New content available."),confirm("[ServiceWorker] Update available -- reload now?")&&window.location.reload()):console.log("SERVICEWORKER: Now available offline.");break;case"redundant":console.log("SERVICEWORKER: Installing worker was redundant.")}}}}catch(e){console.log("SERVICEWORKER: Error during registration: "+e)}}),window.applicationCache&&applicationCache.addEventListener("updateready",function(){confirm("[AppCache] Update available -- reload now?")&&window.location.reload()});let m=null,f={},p=null,y=null;function v(e=a){if(a=e,console.log("PARAMS: "+JSON.stringify(e)),void 0!==e.nodebug&&(l=!1),void 0!==e.debug&&(l=!0),l&&g(),void 0!==e.allowserial&&(d=!0),void 0!==e.noserial&&(d=!1),void 0!==e.allowusb&&(u=!0),void 0!==e.nousb&&(u=!1),!c)return;let t=!1;void 0!==e.editable&&(t=!1),void 0!==e.readonly&&(t=!0);for(let e of["#session","#rate","#range","#gyro","#start","#delay","#duration","#stop","#metadata"]){const o=document.querySelector(e);t?o.setAttribute("disabled","true"):o.removeAttribute("disabled")}let o=!0;void 0!==e.details&&(o=!0),void 0!==e.nodetails&&(o=!1),o?document.querySelector("#details").setAttribute("open","true"):document.querySelector("#details").removeAttribute("open");const n={session:null,rate:100,range:8,gyro:0,start:0,stop:168,metadata:""};let s=!1;for(let t of["session","rate","range","gyro","start","stop","metadata"])void 0!==e[t]&&(n[t]=e[t]),s|=typeof n[t]!=typeof f[t]||n[t]==f[t];s?(f=n,console.log("PARAMS: Config changed: "+JSON.stringify(n)),b(n)):console.log("PARAMS: Config not changed: "+JSON.stringify(n)),e.config&&y.setValue(e.config),void 0!==e.focus&&(document.querySelector("#code").select(),document.querySelector("#code").focus()),L(document.querySelector("#code").value),document.querySelector("#add_usb_device").setAttribute("style",u?"display: inline;":"display: none;"),document.querySelector("#add_serial_device").setAttribute("style",d?"display: inline;":"display: none;"),navigator.serial||document.querySelector("#add_serial_device").setAttribute("style","display: none;")}const b=e=>{document.querySelector("#session").value=void 0!==e.session?e.session:"",document.querySelector("#rate").value=void 0!==e.rate?e.rate:"",document.querySelector("#range").value=void 0!==e.range?e.range:"",document.querySelector("#gyro").value=void 0!==e.gyro?e.gyro:"";let t=E(e.start);t?(document.querySelector("#start").value=(0,n.localTimeString)(t,!0)||"",D()):(document.querySelector("#delay").value=e.start||0===e.start?parseFloat(e.start):"",T());let o=N(e.stop,t);document.querySelector("#stop").value=null===o?document.querySelector("#start").value:(0,n.localTimeString)(o,!0)||"",O(),document.querySelector("#metadata").value=void 0!==e.metadata?e.metadata:"",w()},w=()=>{let e=null;try{e=x(),C("",!1),console.log("CONFIG-VALID: true"),document.querySelector("body").classList.add("config-valid")}catch(e){C(e,!0),console.log("CONFIG-VALID: false"),document.querySelector("body").classList.remove("config-valid")}const t=e&&!!m;y.submitEnabled(t)},S=()=>{let e={deviceType:null,deviceId:"-",battery:"-",state:null,errorState:null};(m=p.getSingleDevice())?(e.deviceId=m.serial||(m.status&&m.status.id&&m.status.id.deviceId?m.status.id.deviceId:"-"),m.status&&m.status.id&&m.status.id.deviceType?e.deviceType=m.status.id.deviceType:m.deviceType&&(e.deviceType=m.deviceType),null!==m.status.battery&&(e.battery=m.status.battery.percent),e.state=m.status.state,e.errorState=m.status.errorState,document.querySelector("body").classList.add("device-connected")):document.querySelector("body").classList.remove("device-connected"),document.querySelector("#device-id").value=e.deviceId+(e.deviceType?" ["+e.deviceType+"]":""),document.querySelector("#battery-meter").value=Number.isNaN(parseInt(e.battery))?0:parseInt(e.battery),document.querySelector("#battery").value=Number.isNaN(parseInt(e.battery))?"-":e.battery+"%",document.querySelector("#state").value=e.state||e.errorState||"-",w()},R=async()=>{if(m=p.getSingleDevice()){console.log("DEVICECHANGED: "+(m.serial?m.serial:"<no serial>")),m.setStatusHandler(S),console.log("DEVICECHANGED: updateStatus...");try{await m.updateStatus(),console.log("STATUS: "+JSON.stringify(m.status))}catch(e){console.log("DEVICECHANGED: ERROR: "+JSON.stringify(e))}}else console.log("DEVICECHANGED: (none)"),await S()},E=e=>{if(!e&&0!==e)return null;if(e&&"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e))return e;if(/\d\d\d\d-\d\d-\d\d[T ]\d\d:\d\d:\d\d(?:\.\d\d\d)?Z?/.test(e))try{return new Date(e)}catch(t){console.log("ERROR: Problem parsing date: "+e)}return null},N=(e,t,o=36e5)=>{if(!e&&0!==e)return null;return E(e)||(t=t||0===t?t:new Date,new Date(t.getTime()+parseFloat(e)*o))},I=()=>""===document.querySelector("#duration").value?null:60*parseFloat(document.querySelector("#duration").value)*60*1e3,D=()=>{(0,n.localTimeValue)(document.querySelector("#start").value),document.querySelector("#delay").value="",A()},T=(e=null)=>{Number(e)===e&&(document.querySelector("#delay").value=e);const t=document.querySelector("#delay").value;if(""!==t.trim()){const e=new Date,o=new Date(e.getTime()+60*parseFloat(t)*60*1e3),s=document.querySelector("#start"),r=(0,n.localTimeString)(o,!0);s.value!=r&&(s.value=r,A())}},O=()=>{const e=(0,n.localTimeValue)(document.querySelector("#start").value),t=(0,n.localTimeValue)(document.querySelector("#stop").value);if(null===t||null===e)return void(document.querySelector("#duration").value="");const o=(t.getTime()-e.getTime())/1e3/60/60;document.querySelector("#duration").value=o},A=e=>{if(Number(e)===e){const t=e/1e3/60/60;document.querySelector("#duration").value=t}const t=(0,n.localTimeValue)(document.querySelector("#start").value);if(t){const e=I(),o=new Date(t.getTime()+e);document.querySelector("#stop").value=(0,n.localTimeString)(o,!0)}else document.querySelector("#stop").value=document.querySelector("#start").value},x=()=>{const e={session:""==document.querySelector("#session").value?null:parseInt(document.querySelector("#session").value),rate:parseFloat(document.querySelector("#rate").value),range:parseInt(document.querySelector("#range").value),gyro:parseInt(document.querySelector("#gyro").value),start:(0,n.localTimeValue)(document.querySelector("#start").value),stop:(0,n.localTimeValue)(document.querySelector("#stop").value),metadata:document.querySelector("#metadata").value},t=[];if(("number"!=typeof e.session||isNaN(e.session))&&t.push("no session ID"),"object"==typeof e.start&&e.start||t.push("no start time"),"object"==typeof e.stop&&e.stop||t.push("no stop time"),I()<=0&&t.push("no valid interval"),t.length>0)throw"Error: "+t.join(", ")+".";return e},C=(e,t=!1)=>{document.querySelector("#result").value=t?"⚠️ "+e:e},L=e=>{console.log("CODE: "+e);const t=e.trim().length>0?parseInt("0"+e.replace(/[^0-9]/g,"").slice(-9)):"";document.querySelector("#session").value=t,document.querySelector("#metadata").value=((e,t,o)=>{e.length>0&&"?"==e[0]&&(e=e.slice(1));const n=e.split("&"),s=[];let r=!1;for(let e of n){const n=e.indexOf("="),i=decodeURIComponent(n>=0?e.slice(0,n):e).replace(/\+/g," ");i.length<=0||(i==t?r||(r=!0,null!==o&&s.push(encodeURIComponent(i)+"="+encodeURIComponent(o))):s.push(e))}return r||null===o||s.push(encodeURIComponent(t)+"="+encodeURIComponent(o)),s.join("&")})(document.querySelector("#metadata").value,"_sc",0==e.length?null:e),w()};let q=!1;const P=async()=>{if(q)C("(device busy)",!0);else{try{q=!0,document.querySelector("input[type=submit]").setAttribute("disabled","true"),document.querySelector("input[type=submit]").style="display: none;",C("Configuring...",!1);const e=x();console.log(JSON.stringify(e,null,4));try{const t=await m.configure(e);console.log("CONFIG-STATUS: "+JSON.stringify(t)),((e,t)=>{let o=!0;for(let n of Object.keys(e))!n in t&&(console.log(`ERROR: Configuration key not found: ${n}`),o=!1),e[n]!=t[n]&&(console.log(`ERROR: Configuration value not matched for '${n}': ${e[n]} != ${t[n]}.`),o=!1);return o})(e,t)?(C("ℹ️ Configured",!1),document.querySelector("body").classList.add("completed")):C("ℹ️ Configured but mismatched",!1)}catch(e){console.log("CONFIG-ERROR: "+JSON.stringify(e)),C(e,!0)}}catch(e){console.log("CONFIGURATION: "+e),C(e,!0)}q=!1,document.querySelector("input[type=submit]").removeAttribute("disabled"),document.querySelector("input[type=submit]").style=""}};window.addEventListener("DOMContentLoaded",async e=>{c=!0,p=new r.default(u,d);for(let e of p.warnings)document.getElementById("warnings").appendChild(document.createTextNode("⚠️ "+e));(y=new s.default("#code")).start(L,P),p.startup(R),document.querySelector("#reconfigure").addEventListener("click",async()=>{document.querySelector("body").classList.remove("completed")}),document.querySelector("#add_usb_device").addEventListener("click",async()=>{try{await p.userAddUsbDevice()}catch(e){C(e,!0)}}),document.querySelector("#add_serial_device").addEventListener("click",async()=>{try{await p.userAddSerialDevice()}catch(e){C(e,!0)}});for(let e of["#delay"]){const t=document.querySelector(e);t.addEventListener("change",T),t.addEventListener("input",T)}for(let e of["#start"]){const t=document.querySelector(e);t.addEventListener("change",D),t.addEventListener("input",D)}for(let e of["#duration"]){const t=document.querySelector(e);t.addEventListener("change",A),t.addEventListener("input",A)}for(let e of["#stop"]){const t=document.querySelector(e);t.addEventListener("change",O),t.addEventListener("input",O)}for(let e of["#session","#rate","#range","#gyro","#delay","#start","#duration","#stop","#metadata"]){const t=document.querySelector(e);t.addEventListener("change",w),t.addEventListener("input",w),t.addEventListener("propertychange",w)}b({session:null,rate:100,range:8,start:0,stop:null,metadata:""}),navigator.usb||document.querySelector("#add_usb_device").setAttribute("disabled","true"),navigator.serial||document.querySelector("#add_serial_device").setAttribute("disabled","true"),v(),setInterval(()=>{T(),p.refreshDevices()},5e3)})},{"./util.mjs":"x7XL","./key_input.mjs":"yzmp","./device_manager.mjs":"bqdr"}]},{},["jOUA"]);</script></head><body> <div class="main"> <header> <h1>AX Configure <span class="version">beta</span></h1> <div id="warnings"><ul> <noscript>⚠️ Scripting not enabled.</noscript> </ul></div> </header> <main> <div class="complete"> <div class="main_button">ℹ️ Configured <input id="reconfigure" class="button" type="button" value="Reconfigure..."></div> </div> <form class="incomplete"> <fieldset> <legend>Configuration</legend> <div><label accesskey="C" for="code">Code: </label><input id="code" type="text" placeholder="..."></div> <details id="details" open> <summary>Details</summary> <div><label for="session">Session ID: </label><input id="session" type="number" placeholder="(none)"></div> <div><label for="rate">Rate: </label> <select id="rate" placeholder=""> <option value="3200">3200 Hz</option> <option value="1600">1600 Hz</option> <option value="800">800 Hz</option> <option value="400">400 Hz</option> <option value="200">200 Hz</option> <option value="100" selected>100 Hz</option> <option value="50">50 Hz</option> <option value="25">25 Hz</option> <option value="12.5">12.5 Hz</option> </select> </div> <div><label for="range">Range: </label> <select id="range" placeholder=""> <option value="16">&PlusMinus;16&#x1D454;</option> <option value="8" selected>&PlusMinus;8&#x1D454;</option> <option value="4">&PlusMinus;4&#x1D454;</option> <option value="2">&PlusMinus;2&#x1D454;</option> </select> </div> <div><label for="gyro">Gyro: </label> <select id="gyro" placeholder=""> <option value="2000">2000 &deg;&#x2215;s</option> <option value="1000">1000 &deg;&#x2215;s</option> <option value="500">500 &deg;&#x2215;s</option> <option value="250">250 &deg;&#x2215;s</option> <option value="0" selected>(none)</option> </select> </div> <div><label for="metadata">Metadata: </label><input id="metadata" type="text" placeholder="(none)"></div> <div><label for="delay">Delay (h): </label><input id="delay" type="number" min="0" placeholder="(hours)" step="any"></div> <div><label for="start">Start: </label><input id="start" type="datetime-local"></div> <div><label for="duration">Duration (h): </label><input id="duration" type="number" min="0" placeholder="(hours)" step="any"></div> <div><label for="stop">Stop: </label><input id="stop" type="datetime-local"></div> </details> <div><output id="result" value="-"></output></div> </fieldset> <div class="connected-valid"> <div class="main_button"><input class="button" type="submit" value="Configure"></div> </div> <div class="disconnected"> <div class="main_button"> <input class="button" id="add_usb_device" type="button" value="Connect USB device..."> <input class="button" id="add_serial_device" type="button" value="Connect serial device..."> </div> </div> </form> <form class="connected"> <fieldset id="device-fieldset"> <legend>Device</legend> <div><label for="device-id">Id: </label><output id="device-id">-</output></div> <div><label for="battery">Battery: </label><meter id="battery-meter" min="0" max="100" low="30" high="85" optimum="100" value="0"></meter> <output id="battery">-</output></div> <div><label for="state">State: </label><output id="state">-</output></div> </fieldset> </form> </main> <footer> <div><a href="https://github.com/digitalinteraction/openmovement-axconfig/blob/master/README.md" title="openmovement-axconfig project">ℹ️ Help</a></div> </footer> </div> <output id="output">-</output> </body></html>