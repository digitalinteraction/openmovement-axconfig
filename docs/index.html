<!doctype html><html __unused__manifest="cache.appcache"><head lang="en"><meta charset="utf-8"><title>AX3 Configure</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;,"><style type="text/css">body,html{height:100%;width:100%}html{font-family:sans-serif;background:#f5f5f5}body{margin:0;display:grid;grid-template-rows:auto fit-content(35vh)}.main{overflow:auto;margin:.5em}#output::-webkit-scrollbar{width:.5em}#output::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3)}#output::-webkit-scrollbar-thumb{background-color:#a9a9a9;outline:1px solid #708090}#output{box-shadow:inset 4px 4px 10px #aaa;background:#fff;color:#000;margin-top:1em;font-family:monospace;overflow-y:auto;padding:.3em 0 .3em .3em;border-radius:4px;height:35vh;display:none}body.console #output{display:block}#output p{font-size:14px;font-weight:700;padding:.2em;margin:0}#output p:nth-child(odd){background:linear-gradient(180deg,rgba(51,238,238,.13),rgba(51,238,238,.13) 50%,rgba(51,153,153,.13) 0,rgba(51,153,85,.13));background-size:100% 2px}.button{box-shadow:inset 0 1px 0 0 #bbdaf7;background:linear-gradient(180deg,#79bbff 5%,#378de5);background-color:#79bbff;border-radius:6px;border:1px solid #84bbf3;display:inline-block;cursor:pointer;color:#fff;font-size:15px;padding:10px 20px;text-decoration:none;text-shadow:0 1px 0 #528ecc}.button:hover{background:linear-gradient(180deg,#378de5 5%,#79bbff);background-color:#378de5}.button:active{position:relative;top:2px}fieldset,form{margin-bottom:6pt}fieldset{border-radius:6pt}fieldset div{display:flex;vertical-align:bottom;margin-top:.2em;margin-bottom:.2em}fieldset label{margin-left:.5em;width:5.5em}fieldset input[type=datetime-local],fieldset input[type=number],fieldset input[type=text],fieldset meter,fieldset output,fieldset select{flex-grow:4}#code{font-size:150%}fieldset #battery{flex-grow:1;margin-left:.5em}.disconnected{display:block}.connected,.device-connected .disconnected{display:none}.device-connected .connected{display:block}</style><script __not__type="module">parcelRequire=function(e,t,n,o){var s,i="function"==typeof parcelRequire&&parcelRequire,r="function"==typeof require&&require;function a(n,o){if(!t[n]){if(!e[n]){var s="function"==typeof parcelRequire&&parcelRequire;if(!o&&s)return s(n,!0);if(i)return i(n,!0);if(r&&"string"==typeof n)return r(n);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}u.resolve=function(t){return e[n][1][t]||t},u.cache={};var l=t[n]=new a.Module(n);e[n][0].call(l.exports,u,l,l.exports,this)}return t[n].exports;function u(e){return a(u.resolve(e))}}a.isParcelRequire=!0,a.Module=function(e){this.id=e,this.bundle=a,this.exports={}},a.modules=e,a.cache=t,a.parent=i,a.register=function(t,n){e[t]=[function(e,t){t.exports=n},{}]};for(var c=0;c<n.length;c++)try{a(n[c])}catch(e){s||(s=e)}if(n.length){var l=a(n[n.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd&&define(function(){return l})}if(parcelRequire=a,s)throw s;return a}({x7XL:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.sleep=async function(e){return new Promise(t=>setTimeout(t,e))},n.localTimeString=function(e){if("object"!=typeof e)return null;const t=60*(new Date).getTimezoneOffset()*1e3;return new Date(e.getTime()-t).toISOString().slice(0,-1)},n.localTimeValue=function(e){if("string"!=typeof e||0===e.length)return null;16==e.length&&(e+=":00"),19==e.length&&(e+=".000"),23==e.length&&(e+="Z");const t=60*(new Date).getTimezoneOffset()*1e3;return new Date(new Date(e).getTime()+t)},n.watchParameters=function(e){function t(){const t=new URL(window.location.href),n=t.searchParams,o=new URLSearchParams(t.hash.replace(/^#/,"")),s=[];for(let e of[n,o])for(let t of e.entries())s.push(t);const i={};for(let e of s)i[e[0].toLowerCase()]=e[1];e(i,s)}window.onhashchange=t,t()},n.redirectConsole=function(e,t="P"){function n(e,n,...o){const s=document.querySelector(e),i=o.join(" ");if(!s)return"[pre-DOM] "+i;const r=document.createTextNode(i),a=document.createElement(t);return a.appendChild(r),s.appendChild(a),a.scrollIntoView(!1),i}for(let t of["log","warn","error"]){const o=console[t];console[t]=function(){const s=n(e,t,...arguments);o(s)}}}},{}],yzmp:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;n.default=class{constructor(e){this.inputSelector=e,this.inputBuffer="",this.timeoutId=null}start(e=null,t=null){this.changeCallback=e,document.onkeydown=this.keydown.bind(this);const n=()=>{const t=document.querySelector(this.inputSelector);if(e){const n=t.value;e(n)}},o=document.querySelector(this.inputSelector);o.addEventListener("input",n),o.addEventListener("change",n),o.addEventListener("focus",function(){this.select()}),o.form.onsubmit=e=>{const n=document.querySelector(this.inputSelector);if(e.preventDefault(),n.blur(),!n.form.querySelector("input[type=submit]").disabled&&t){const e=n.value;t(e)}return!1},n()}setValue(e,t=!1){this.inputBuffer="";const n=document.querySelector(this.inputSelector);if(n){if(arguments.length>0&&(console.log("KEYINPUT: "+e),n.value=e),n.dispatchEvent(new Event("change",{bubbles:!0})),t){const e=n.form.querySelector('input[type="submit"]');e&&e.click()}}else console.log("KEYINPUT: Error: element not found: "+this.inputSelector)}submitEnabled(e){document.querySelector(this.inputSelector).form.querySelector("input[type=submit]").disabled=!e}keydown(e){let t=!0;e=e||window.event,this.inputSelector||(t=!1),document.activeElement&&("INPUT"==document.activeElement.tagName&&["text","password","date","email","number","search"].indexOf(document.activeElement.type)>=0&&(t=!1),"TEXTAREA"==document.activeElement.tagName&&(t=!1)),(e.altKey||e.ctrlKey)&&(t=!1),e.which<32&&(this.inputBuffer.length>0&&13==e.which&&(e.preventDefault(),this.setValue(this.inputBuffer,!0)),t=!1),e.key&&1==e.key.length||(t=!1),null!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),t?(e.preventDefault(),this.inputBuffer+=e.key,this.timeoutId=setTimeout(function(){this.inputBuffer=""}.bind(this),2e3)):this.inputBuffer=""}}},{}],sLgq:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var o=e("./util.mjs");const s=new TextEncoder("windows-1252"),i=new TextDecoder("windows-1252");function r(e){let t=null,n=null;for(let o of e.interfaces)o.alternates[0].interfaceClass==u.USB_CLASS_COMM?t=o.interfaceNumber:o.alternates[0].interfaceClass==u.USB_CLASS_CDC_DATA&&(n=o.interfaceNumber);if(null===t)return console.log("WARNING: CDC control interface not found in configuration "+e.configurationValue),null;null===n&&(console.log("NOTE: CDC data interface not found in configuration "+e.configurationValue+" -- will continue and assume malformed CDC using a single interface"),n=t);let o=null;for(let n of e.interfaces[t].alternates[0].endpoints)"in"===n.direction&&"interrupt"===n.type&&(o=n.endpointNumber);if(null===o)return console.log("WARNING: CDC control endpoint not found in configuration "+e.configurationValue),null;let s=null,i=null;for(let r of e.interfaces[n].alternates[0].endpoints)n==t&&r.endpointNumber==o||("in"===r.direction&&"bulk"===r.type?s=r.endpointNumber:"out"===r.direction&&"bulk"===r.type?i=r.endpointNumber:console.log("NOTE: Data endpoint ignored "+r.endpointNumber));return null===s||null===i?(console.log("WARNING: CDC data read/write endpoints not found in configuration "+e.configurationValue),null):{configurationValue:e.configurationValue,control:{interface:t,endpoint:o},data:{interface:n,endpointRead:s,endpointWrite:i}}}function a(e){let t=null;for(let n of e.interfaces)255==n.alternates[0].interfaceClass&&(t=n.interfaceNumber);if(null===t)return null;let n=null,o=null;for(let s of e.interfaces[t].alternates[0].endpoints)"in"===s.direction&&"bulk"===s.type&&(n=s.endpointNumber),"out"===s.direction&&"bulk"===s.type&&(o=s.endpointNumber);return null===n||null===o?(console.log("WARNING: Generic data read/write endpoints not found in configuration "+e.configurationValue),null):{configurationValue:e.configurationValue,data:{interface:t,endpointRead:n,endpointWrite:o}}}class c{constructor(e,t,n){this.output=e,this.prefix=t,this.timeout=n}isTerminal(e){return!(!this.prefix&&""!==this.prefix||!e.startsWith(this.prefix))}}class l{constructor(e){this.started=(new Date).getTime(),this.command=e,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t}),this.lines=[],this.completed=!1,this.error=null}addResponse(e){this.lines.push(e);const t=this.command.isTerminal(e);return console.log(`...now have ${this.lines.length} line(s) (terminal=${t})`),!!t}lastLine(){return this.completed&&this.lines.length>0?this.lines[this.lines.length-1]:null}complete(e=null){null!=e?(this.error=e,this.reject(this)):(this.completed=!0,this.resolve(this))}checkTimeout(){const e=(new Date).getTime()-this.started;return!(this.completed||this.error||!this.command.timeout||!(e>=this.command.timeout))}}class u{constructor(e){this.device=e,console.log("--- COMMS ---"),console.log(this.device.productName),console.log(this.device.manufacturerName),console.log(this.device.serialNumber),this.serial=function(e){if(null==e)return null;if(!(e=e.trim()).startsWith("AX")&&!e.startsWith("CWA"))return null;for(let t=e.length-1;;t--)if(t<0||!(e.charCodeAt(t)>=48&&e.charCodeAt(t)<=57))return t+1>=e.length?null:parseInt(e.substring(t+1))}(this.device.serialNumber),console.log("SERIAL: "+this.serial),this.io=null,this.commandQueue=[],this.currentCommand=null,this.currentTimeout=null,this.nextTick=null,this.receiveBuffer="",this.statusHandler=null,this.status={id:{deviceId:null},battery:{percent:null,time:null},start:null,stop:null,state:null,errorState:null},this.recalculateRecordingStatus()}setStatusHandler(e){this.statusHandler=e}statusChanged(){this.statusHandler&&this.statusHandler(this,this.status)}updateState(e,t){console.log("STATE: "+e+" / "+t),this.status.state=e,this.status.errorState=t,this.statusChanged()}async exec(e){console.log("exec()");const t=new l(e);return this.commandQueue.push(t),null==this.currentCommand&&null==this.nextTick&&(console.log("exec(): bootstrap"),this.nextTick=setTimeout(async()=>{console.log("exec(): bootstrap..."),await this.execNext(),console.log("exec(): bootstrap... done")},0)),console.log("exec(): return"),t.promise}async execNext(){if(console.log("execNext()"),null==this.currentCommand){if(console.log("execNext(): no command..."),this.commandQueue.length<=0)return console.log("execNext(): no more commands"),void(this.nextTick=null);console.log("execNext(): getting next command..."),this.currentCommand=this.commandQueue.shift(),this.currentCommand.command.timeout?(console.log("execNext(): setting up new timeout: "+this.currentCommand.command.timeout),this.currentTimeout=setTimeout(this.timeout.bind(this),this.currentCommand.command.timeout)):console.log("execNext(): command has no timeout");try{console.log("execNext(): write: "+this.currentCommand.command.output),await this.write(this.currentCommand.command.output),console.log("execNext(): write: (done)")}catch(e){console.log("execNext(): write: exception: "+e),this.commandComplete(e)}}if(this.currentCommand){let e=null;try{this.currentCommand&&this.currentCommand.checkTimeout()&&(console.log("execNext(): timeout"),this.commandComplete("Timeout before read")),console.log("execNext(): read"),e=await this.read()}catch(e){console.log("execNext(): read exception: "+e),this.commandComplete(e)}if(this.currentCommand&&null!==e)for(console.log("execNext(): adding data "+e.length),this.receiveBuffer+=e;;){const e=this.receiveBuffer.indexOf("\n");if(e<0)break;const t=this.receiveBuffer.slice(0,e).trim();if(console.log("LINE: "+t),this.receiveBuffer=this.receiveBuffer.slice(e+1),this.currentCommand.addResponse(t)){console.log("execNext(): end"),this.commandComplete();break}}else console.log("execNext(): (no command or no data) ")}this.nextTick=setTimeout(async()=>{console.log("execNext(): ..."),await this.execNext(),console.log("execNext(): ... done")},0),console.log("execNext(): end")}async timeout(){console.log("timeout(): ..."),this.currentTimeout=null,this.currentCommand?(console.log("timeout(): ...cancel..."),await this.cancelRead(),commandComplete("Timeout")):console.log("timeout(): no current command"),console.log("timeout(): ...done")}commandComplete(e=null){null!==e?console.log("commandComplete(): FAILED "+e+" -- "+this.currentCommand.command.output):console.log("commandComplete(): SUCCESS -- "+this.currentCommand.command.output),this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),this.currentCommand&&this.currentCommand.complete(e),this.currentCommand=null}async open(){this.receiveBuffer="";try{await this.device.open()}catch(e){throw console.log("ERROR: Problem opening device: "+e,e.name+" -- "+e.message),"file:"==location.protocol&&console.log("NOTE: Hosting from a file: protocol may cause this. Try serving over HTTP."),"SecurityError"==e.name&&navigator.appVersion.indexOf("(Windows")>=0&&console.log('NOTE: The "new" Windows WebUSB back-end may have this issue.'),e}console.log("Determine I/O..."),this.io=null;for(let e of this.device.configurations){if(this.io=a(e),null!==this.io)break;if(this.io=r(e),null!==this.io)break}if(null===this.io)throw console.log("ERROR: No matching configuration found."),"No matching configuration found";console.log("IO FOUND, selecting configuration: "+JSON.stringify(this.io));try{await this.device.selectConfiguration(this.io.configurationValue)}catch(e){throw console.log("ERROR: Problem selecting configuration: "+this.io.configurationValue+" -- "+e),e}console.log("...claiming interfaces...");try{await this.device.claimInterface(this.io.data.interface)}catch(e){throw console.log("ERROR: Problem claiming data interface (could it already be claimed by a driver?): "+this.io.data.interface+" -- "+e),e}console.log("...opened")}async close(){try{await this.device.releaseInterface(this.io.data.interface)}catch(e){console.log("WARNING: Problem releasing data interface: "+this.io.data.interface+" -- "+e)}finally{try{return console.log("...close..."),await this.device.close(),console.log("...closed"),!0}catch(e){return console.log("WARNING: Problem closing device -- "+e),!1}}}async write(e){console.log("SEND: "+e);let t=s.encode(e);console.log("===: "+t);try{await this.device.transferOut(this.io.data.endpointWrite,t)}catch(e){throw console.log("WARNING: Problem writing data: "+this.io.data.endpointWrite+" -- "+t+" -- "+e),e}}async read(){console.log("Read...");let e=null;try{console.log(`...transferIn(${this.io.data.endpointRead})`);let t=await this.device.transferIn(this.io.data.endpointRead,64);if(console.log(`...transferIn() - done (${t.status}): `+t),"stall"===t.status&&(console.log("Endpoint stalled. Clearing."),await this.device.clearHalt("in",this.io.data.endpointRead)),"ok"===t.status)if(t.data&&t.data.byteLength>0){let n=0;for(let e=0;e<t.data.byteLength;e++){let e=t.data.getUint8();(e>=128||e<32&&"\r"!=e&&"\n"!=e)&&(buffer.setUint8(32),n++)}n>0&&console.log(`NOTE: Replaced ${n} of ${t.data.byteLength} bytes.`),e=i.decode(t.data)}else console.log("WARNING: Transfer was ok but no data: "+t.data.byteLength);else console.log("WARNING: Transfer result: "+t.status)}catch(e){return console.log("WARNING: Problem reading data: "+this.io.data.endpointRead+" -- "+e),null}return console.log("RECV: "+(null===e?"<null>":e.replace(/[\r\n]/g,"|"))),e}async cancelRead(){try{return console.log("cancelRead() - "+this.io.data.endpointRead),await this.device.clearHalt("in",this.io.data.endpointRead),console.log("cancelRead() - done"),!0}catch(e){return console.log("WARNING: Problem cancelling read: "+this.io.data.endpointRead+" -- "+e),!1}}isBusy(){return this.device.opened}parseDateTime(e){if("0"==e)return 0;if("-1"==e)return-1;const t=parseInt(e.substring(0,4),10),n=parseInt(e.substring(5,7),10),o=parseInt(e.substring(8,10),10),s=parseInt(e.substring(11,13),10),i=parseInt(e.substring(14,16),10),r=parseInt(e.substring(17,19),10),a=new Date(t,n-1,o,s,i,r,0);return a.getFullYear()<2e3?0:a.getFullYear()>=2064?-1:a}packDateTime(e=null){if(null===e&&(e=new Date),0==e)return"0";if(-1==e)return"-1";let t=e.getFullYear()+"/";return(t=(t=(t=(t=t+(e.getMonth()+1<10?"0":"")+(e.getMonth()+1)+"/")+(e.getDate()<10?"0":"")+e.getDate()+",")+(e.getHours()<10?"0":"")+e.getHours()+":")+(e.getMinutes()<10?"0":"")+e.getMinutes()+":")+(e.getSeconds()<10?"0":"")+e.getSeconds()}async getConfigOptions(){return{accelRate:[6.25,12.5,25,50,100,200,400,800,1600,3200],accelRange:[2,4,8,16]}}async getId(){const e=new c("\r\nID\r\n","ID=",2e3);console.log(">>> "+e.output);const t=(await this.exec(e)).lastLine();console.log("<<< "+t);const n=t.substring(t.indexOf("=")+1).split(",");return{deviceType:n[0],deviceId:parseInt(n[3],10),firmwareVersion:parseInt(n[2],10)}}async getBattery(){const e=new c("\r\nSAMPLE 1\r\n","$BATT=",2e3);console.log(">>> "+e.output);const t=(await this.exec(e)).lastLine();console.log("<<< "+t);const n=t.substring(t.indexOf("=")+1).split(",").map(e=>parseInt(e,10));return{voltage:n[1]/1e3,percent:n[3],charging:n[4],time:new Date}}async setLed(e){const t=new c(`\r\nLED ${e}\r\n`,"LED=",2e3);console.log(">>> "+t.output);const n=(await this.exec(t)).lastLine();console.log("<<< "+n);const o=n.substring(n.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(o[0]!=e)throw`LED value unexpected: was ${o[0]}, expected ${e}`}async setTime(e=null){this.updateState("Setting time");let t=e;null===t&&(t=new Date);const n=this.packDateTime(t),o=new c(`\r\nTIME ${n}\r\n`,"$TIME=",2e3);console.log(">>> "+o.output);const s=(await this.exec(o)).lastLine();console.log("<<< "+s);const i=this.parseDateTime(s.substring(s.indexOf("=")+1)),r=i.getTime()-t.getTime();if(Math.abs(r)>2e3)throw`Time value difference too large: received ${i.toISOString()}, expected closer to ${t.toISOString()}`}async setSession(e){const t=parseInt(e);if(this.updateState("Setting session ID"),"number"!=typeof t||isNaN(t)||t<0||t>2147483647)throw"Session ID invalid value";const n=new c(`\r\nSESSION ${t}\r\n`,"SESSION=",2e3);console.log(">>> "+n.output);const o=(await this.exec(n)).lastLine();console.log("<<< "+o);const s=o.substring(o.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(s[0]!=t)throw`SESSION value unexpected: was ${s[0]}, expected ${t}`}async setMaxSamples(e){this.updateState("Setting max samples");const t=new c(`\r\nMAXSAMPLES ${e}\r\n`,"MAXSAMPLES=",2e3);console.log(">>> "+t.output);const n=(await this.exec(t)).lastLine();console.log("<<< "+n);const o=n.substring(n.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(o[0]!=e)throw`MAXSAMPLES value unexpected: was ${o[0]}, expected ${e}`}async getHibernate(e){const t=new c("\r\nHIBERNATE\r\n","HIBERNATE=",2e3);console.log(">>> "+t.output);const n=(await this.exec(t)).lastLine();console.log("<<< "+n);const o=n.substring(n.indexOf("=")+1);return this.parseDateTime(o)}async setHibernate(e){this.updateState("Setting start");const t=this.packDateTime(e),n=new c(`\r\nHIBERNATE ${t}\r\n`,"HIBERNATE=",2e3);console.log(">>> "+n.output);const o=(await this.exec(n)).lastLine();console.log("<<< "+o);const s=o.substring(o.indexOf("=")+1);if(t!=s)throw`HIBERNATE value unexpected: was ${s}, expected ${t}`}async getStop(e){const t=new c("\r\nSTOP\r\n","STOP=",2e3);console.log(">>> "+t.output);const n=(await this.exec(t)).lastLine();console.log("<<< "+n);const o=n.substring(n.indexOf("=")+1);return this.parseDateTime(o)}async setStop(e){this.updateState("Setting stop");const t=this.packDateTime(e),n=new c(`\r\nSTOP ${t}\r\n`,"STOP=",2e3);console.log(">>> "+n.output);const o=(await this.exec(n)).lastLine();console.log("<<< "+o);const s=o.substring(o.indexOf("=")+1);if(s.indexOf(t)<0)throw`STOP value unexpected: was ${s}, expected ${t}`}async setRate(e,t){this.updateState("Setting rate");let n=0;switch(parseFloat(e)){case 3200:n|=15;break;case 1600:n|=14;break;case 800:n|=13;break;case 400:n|=12;break;case 200:n|=11;break;case 100:n|=10;break;case 50:n|=9;break;case 25:n|=8;break;case 12.5:case 12:n|=7;break;case 6.25:case 6:n|=6;break;default:throw"Invalid accelerometer frequency."}switch(parseInt(t)){case 16:n|=0;break;case 8:n|=64;break;case 4:n|=128;break;case 2:n|=192;break;default:throw"Invalid accelerometer sensitivity."}const o=new c(`\r\nRATE ${n}\r\n`,"RATE=",2e3);console.log(">>> "+o.output);const s=(await this.exec(o)).lastLine();console.log("<<< "+s);const i=s.substring(s.indexOf("=")+1).split(",").map(e=>parseInt(e,10));if(i[0]!=n)throw`RATE value unexpected: was ${i[0]}, expected ${n}`;if(i[1]!=e)throw`RATE frequency unexpected: was ${i[1]}, expected ${e}`}async readSector(e){const t=new c(`\r\nREADL ${e}\r\n`,"OK",1e4);console.log(">>> "+t.output);const n=await this.exec(t),o=new DataView(new ArrayBuffer(512),0);let s=0;for(let e of n.lines){if(e.startsWith("READL="))continue;if(e.startsWith("OK"))continue;const t=e.split(":",1),n=parseInt(t,16);if(n!=s)throw`Unexpected sector offset ${n}, expected ${s}`;const i=e.trim().slice(t.length+1,-16).replace(/\ /g,""),r=i.length/2;if(16!=r)throw`Unexpected sector line length ${i.length} -> ${r}, expected 32 -> 16`;for(let e=0;e<r;e++){const t=parseInt(i.slice(2*e,2*e+2),16);o.setUint8(t),s++}}if(512!=s)throw`Unexpected sector size ${s}, expected 512`;return o}async readFilesystem(){this.updateState("Reading filesystem");const e={};e.mbrSector=await this.readSector(0),e.firstSectorNumber=e.mbrSector.getUint32(454,!0),e.bootSector=await this.readSector(e.firstSectorNumber),e.sectorsPerCluster=e.bootSector.getUint16(12,!0),e.numReservedSectors=e.bootSector.getUint16(14,!0),e.numFATs=e.bootSector.getUint8(16),e.numRootDirectoryEntries=e.bootSector.getUint16(17,!0),e.sectorsPerFAT=e.bootSector.getUint16(22,!0),e.rootSectorNumber=e.firstSectorNumber+e.numReservedSectors+e.numFATs*e.sectorsPerFAT,e.rootSector=await this.readSector(e.rootSectorNumber),e.firstSectorOfFileArea=e.rootSectorNumber+Math.floor(32*e.numRootDirectoryEntries/512),e.dataLength=null;for(let t=0;t<16;t++){const n=32*t,o="CWA-DATACWA";let s=!0;for(let t=0;t<o.length;t++)if(e.rootSector.getUint8(n+t)!=o.charCodeAt(t)){s=!1;break}if(s){e.dataLength=e.rootSector.getUint32(n+28,!0);break}}return{firstSectorNumber:firstSectorNumber,sectorsPerCluster:sectorsPerCluster,numReservedSectors:numReservedSectors,numFATs:numFATs,numRootDirectoryEntries:numRootDirectoryEntries,sectorsPerFAT:sectorsPerFAT,rootSectorNumber:rootSectorNumber,firstSectorOfFileArea:firstSectorOfFileArea,dataLength:dataLength}}async setMetadata(e){for(let t=0;t<14;t++){this.updateState(`Setting metadata (${t+1} / 14)`);let n="";const o=32*t;let s=32*(t+1);o<e.length&&(s>e.length&&(s=e.length),n=e.substring(o,s));const i="ANNOTATE"+(t<10?"0":"")+t+"=",r=new c(`\r\n${"Annotate"+(t<10?"0":"")+t+"="+n+"\r\n"}\r\n`,i,2e3);console.log(">>> "+r.output);const a=(await this.exec(r)).lastLine();console.log("<<< "+a);const l=a.substring(a.indexOf("=")+1);if(l.trim()!=n.trim())throw`${i} unexpected value, received "${l.trim()}", expected "${n.trim()}"`}}async commit(e){let t;if(!0===e)this.updateState("Wipe and commit"),t=new c("\r\nFORMAT WC\r\n","COMMIT",1e4);else if(!1===e)this.updateState("Erase and commit"),t=new c("\r\nFORMAT QC\r\n","COMMIT",8e3);else{if(null!==e)throw"ERROR: Unknown commit type.";this.updateState("Committing"),t=new c("\r\nCommit\r\n","COMMIT",5e3)}console.log(">>> "+t.output);const n=(await this.exec(t)).lastLine();console.log("<<< "+n)}async tryAndRetry(e,t=3,n=1e3){let s="Unexpected failure in retry logic.";for(let i=0;i<t;i++)try{return n&&i>0&&(console.log(`Retrying in ${n/1e3}s...`),await(0,o.sleep)(n)),await e()}catch(e){s=e,console.log(`WARNING: Failed attempt (${i+1}/${t}): `+(e.error?e.error:e))}throw s}async updateStatus(){if(this.isBusy())throw this.updateState(null,"Device busy"),"ERROR: Device is busy";try{if(this.updateState("Querying status"),await this.tryAndRetry(()=>this.open()),null===this.status.id||null===this.status.id.deviceId){if(this.status.id=await this.tryAndRetry(()=>this.getId()),this.status.id.deviceId!=this.serial)throw`ERROR: Device id mismatch: reported ID=${this.status.id.deviceId} but USB serial number was ${this.serial}.`;console.log("ID="+JSON.stringify(this.status.id))}const e=new Date;return(null===this.status.battery||null===this.status.battery.percent||null===this.status.battery.time||e.getTime()-this.status.battery.time.getTime()>=3e4)&&(this.status.battery=await this.tryAndRetry(()=>this.getBattery()),console.log("BATTERY="+JSON.stringify(this.status.battery))),null===this.status.start&&(this.status.start=await this.tryAndRetry(()=>this.getHibernate())),null===this.status.stop&&(this.status.stop=await this.tryAndRetry(()=>this.getStop())),this.recalculateRecordingStatus(),this.updateState("Ready"),this.status}catch(e){throw e.error?(this.updateState(null,`Error getting status: ${e.error}`),console.log("ERROR: Problem during status update: "+e.error)):(this.updateState(null,`Error getting status: ${e}`),console.log("ERROR: Problem during status update: "+e)),e}finally{await this.close()}}recalculateRecordingStatus(){const e=Date.UTC(-271821,3,20),t=Date.UTC(275760,8,13),n=new Date;let o=this.status.start;-1===o&&(o=t),0===o&&(o=e);let s=this.status.stop;-1===s&&(o=t),0===s&&(o=e),this.status.recordingConfigured=o<s,this.status.recordingFinished=n>s,this.status.recordingStarted=n>o,this.status.recordingFuture=this.status.recordingConfigured&&!this.status.recordingFinished}async configure(e){if(this.isBusy())throw this.updateState(null,"Device busy"),"ERROR: Device is busy";try{this.updateState("Configuring..."),await this.tryAndRetry(()=>this.open());const t=Object.assign({minBattery:null,configLed:u.LED_BLUE,time:null,sessionId:0,maxSamples:0,accelRate:100,accelRange:8,hibernate:-1,stop:0,metadata:"",led:u.LED_MAGENTA,wipe:!0,noData:!1},e);if(console.log("ID="+JSON.stringify(this.status.id)),this.status.id.deviceId!=this.serial)throw`ERROR: Device id mismatch (was status updated first?): reported ID=${this.status.id.deviceId} but USB serial number was ${this.serial}.`;if(await this.tryAndRetry(()=>this.setLed(t.configLed)),console.log("BATTERY="+JSON.stringify(this.status.battery)),this.status.battery.percent<t.minBattery)throw`ERROR: Device battery level too low: ${this.status.battery.percent}% (required ${t.minBattery}%).`;if(t.noData){const e=await this.tryAndRetry(()=>this.readFilesystem());if(console.log("FILESYSTEM="+JSON.stringify(e)),e.dataLength&&e.dataLength>1024)throw"ERROR: Device has data on it."}return t.time||(t.time=new Date),await this.tryAndRetry(()=>this.setTime(t.time)),await this.tryAndRetry(()=>this.setSession(t.sessionId)),await this.tryAndRetry(()=>this.setMaxSamples(t.maxSamples)),await this.tryAndRetry(()=>this.setRate(t.accelRate,t.accelRange)),await this.tryAndRetry(()=>this.setHibernate(t.start)),await this.tryAndRetry(()=>this.setStop(t.stop)),await this.tryAndRetry(()=>this.setMetadata(t.metadata)),await this.tryAndRetry(()=>this.commit(t.wipe)),this.status.start=t.start,this.status.stop=t.stop,this.recalculateRecordingStatus(),await this.tryAndRetry(()=>this.setLed(t.led)),this.updateState("Configured"),{time:t.time,deviceId:this.status.id.deviceId,battery:battery.percent,start:t.start,stop:t.stop,sessionId:t.sessionId,accelRate:t.accelRate,accelRange:t.accelRange,metadata:t.metadata}}catch(e){throw e.error?(this.updateState(null,`Error: ${e.error}`),console.log("ERROR: Problem during configuration: "+e.error)):(this.updateState(null,`Error: ${e}`),console.log("ERROR: Problem during configuration: "+e)),e}finally{await this.close()}}}n.default=u,u.USB_DEVICE_VID=1240,u.USB_DEVICE_PID=87,u.USB_CLASS_COMM=2,u.USB_CLASS_CDC_DATA=10,u.LED_OFF=0,u.LED_BLUE=1,u.LED_GREEN=2,u.LED_CYAN=3,u.LED_RED=4,u.LED_MAGENTA=5,u.LED_YELLOW=6,u.LED_WHITE=7},{"./util.mjs":"x7XL"}],bqdr:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var o=function(e){return e&&e.__esModule?e:{default:e}}(e("./ax3device.mjs"));n.default=class{constructor(){this.devices={},navigator.appVersion.indexOf("(Windows")>=0&&console.log("WARNING: On Windows, CDC devices are likely to be claimed by the driver."),"file:"===location.protocol&&console.log("WARNING: WebUSB may not work over the file: protocol -- try via a web server."),"https:"!==location.protocol&&console.log("WARNING: WebUSB may require secure HTTPS."),navigator.usb||console.log("ERROR: WebUSB not supported in this browser.")}async startup(e){if(this.changedHandler=e,!navigator.usb)return!1;navigator.usb.addEventListener("disconnect",e=>{const t=e.device;console.log("DEVICEMANAGER: Disconnect "+t);const n=this.devices[t];delete this.devices[t],this.changedHandler&&this.changedHandler(n,t,"disconnect")}),navigator.usb.addEventListener("connect",e=>{const t=e.device;console.log("DEVICEMANAGER: Connect "+t);const n=new o.default(t);this.devices[t]=n,this.changedHandler&&this.changedHandler(n,t,"connect")});const t=await navigator.usb.getDevices();for(let e of t){console.log("DEVICEMANAGER: Enumerate "+e);const t=new o.default(e);this.devices[e]=t,this.changedHandler&&this.changedHandler(t,e,"get")}return!0}async userAddDevice(){if(!navigator.usb)return!1;try{const e=await navigator.usb.requestDevice({filters:[{vendorId:o.default.USB_DEVICE_VID,productId:o.default.USB_DEVICE_PID}]});console.log("DEVICEMANAGER: Request "+e);const t=new o.default(e);return this.devices[e]=t,this.changedHandler&&this.changedHandler(t,e,"request"),!0}catch(e){return"NotFoundError"==e.name?console.log("NOTE: User did not select a device: "+e.name+" -- "+e.message):console.log("ERROR: "+e+" -- "+e.name+" -- "+e.message),!1}}getSingleDevice(){const e=Object.keys(this.devices).length;return console.log("DEVICEMANAGER: Has "+e+" device(s)."),1!=e?null:Object.values(this.devices)[0]}}},{"./ax3device.mjs":"sLgq"}],jOUA:[function(e,t,n){"use strict";var o=e("./util.mjs"),s=r(e("./key_input.mjs")),i=r(e("./device_manager.mjs"));function r(e){return e&&e.__esModule?e:{default:e}}window.addEventListener("error",function(e){return console.log("ERROR: Unhandled error occurred: "+e.error.message),console.log(JSON.stringify(e)),!1}),(0,o.redirectConsole)("#output");let a=null;window.addEventListener("DOMContentLoaded",async e=>{const t=new i.default,n=()=>{let e=null;try{e=l(),u("",!1)}catch(e){u(e,!0)}const t=e&&!!a;d.submitEnabled(t)},r=()=>{let e={deviceId:"-",battery:"-",state:null,errorState:null};(a=t.getSingleDevice())?(e.deviceId=a.serial,null!==a.status.battery&&(e.battery=a.status.battery.percent),e.state=a.status.state,e.errorState=a.status.errorState,document.querySelector("body").classList.add("device-connected")):document.querySelector("body").classList.remove("device-connected"),document.querySelector("#device-id").value=e.deviceId,document.querySelector("#battery-meter").value=Number.isNaN(parseInt(e.battery))?0:parseInt(e.battery),document.querySelector("#battery").value=Number.isNaN(parseInt(e.battery))?"-":e.battery+"%",document.querySelector("#state").value=e.state||e.errorState||"-",n()},c=e=>{document.querySelector("#session-id").value=e.sessionId,document.querySelector("#rate").value=e.rate,document.querySelector("#range").value=e.range,document.querySelector("#start").value=e.start?(0,o.localTimeString)(e.start).slice(0,-7):null,document.querySelector("#stop").value=e.stop?(0,o.localTimeString)(e.stop).slice(0,-7):null,document.querySelector("#metadata").value=e.metadata,n()},l=()=>{const e={sessionId:parseInt(document.querySelector("#session-id").value),rate:parseFloat(document.querySelector("#rate").value),range:parseInt(document.querySelector("#range").value),start:(0,o.localTimeValue)(document.querySelector("#start").value),stop:(0,o.localTimeValue)(document.querySelector("#stop").value),metadata:document.querySelector("#metadata").value},t=[];if(("number"!=typeof e.sessionId||isNaN(e.sessionId))&&t.push("session ID"),"object"==typeof e.start&&e.start||t.push("start time"),"object"==typeof e.stop&&e.stop||t.push("stop time"),t.length>0)throw"Not specified: "+t.join(", ")+".";return e},u=(e,t=!1)=>{document.querySelector("#result").value=t?"⚠️ "+e:e};let d=new s.default("#code");d.start(e=>{console.log("CODE: "+e),n()},async()=>{document.querySelector("#code").value;try{u("Configuring...",!1);const e=l();console.log(JSON.stringify(e,null,4));try{const t=await a.configure(e);console.log("CONFIG-STATUS: "+JSON.stringify(t)),u("Configured",!1)}catch(e){console.log("CONFIG-ERROR: "+JSON.stringify(e)),u(e,!0)}}catch(e){console.log("CONFIGURATION: "+e),u(e,!0)}}),t.startup(async()=>{(a=t.getSingleDevice())?(console.log("DEVICECHANGED: "+a.serial),a.setStatusHandler(r),console.log("DEVICECHANGED: updateStatus..."),await a.updateStatus(),console.log("STATUS: "+JSON.stringify(a.status))):(console.log("DEVICECHANGED: (none)"),r())}),document.querySelector("#add_device").addEventListener("click",async()=>{await t.userAddDevice()}),document.querySelector("#test").addEventListener("click",()=>{const e=new Date,t={sessionId:123456789,rate:100,range:8,start:new Date(e.getTime()+6e4),stop:new Date(e.getTime()+12e4),metadata:"Hello_world!"};c(t)}),(0,o.watchParameters)(e=>{console.log("PARAMS: "+JSON.stringify(e)),document.querySelector("body").classList.toggle("console",void 0===e.noconsole),e.config&&d.setValue(e.config)});for(let e of["#session-id","#rate","#range","#start","#stop","#metadata"]){const t=document.querySelector(e);t.addEventListener("change",n),t.addEventListener("input",n),t.addEventListener("propertychange",n)}console.log("Clearing config..."),c({sessionId:null,rate:100,range:8,start:null,stop:null,metadata:""})})},{"./util.mjs":"x7XL","./key_input.mjs":"yzmp","./device_manager.mjs":"bqdr"}]},{},["jOUA"]);</script></head><body> <div class="main"> <h1>AX3 Configure</h1> <form> <fieldset> <legend>Configuration</legend> <div><label accesskey="C" for="code">Code: </label><input id="code" type="text" placeholder="..."></div> <div><output id="result" value="-"></output></div> <div><input id="test" type="button" value="Use Test Data"></div> <details> <summary>Details</summary> <div><label for="session-id">Session ID: </label><input id="session-id" type="number" placeholder="(none)"></div> <div><label for="rate">Rate: </label> <select id="rate" placeholder=""> <option value="3200">3200 Hz</option> <option value="1600">1600 Hz</option> <option value="800">800 Hz</option> <option value="400">400 Hz</option> <option value="200">200 Hz</option> <option value="100" selected>100 Hz</option> <option value="50">50 Hz</option> <option value="25">25 Hz</option> <option value="12.5">12.5 Hz</option> </select> </div> <div><label for="range">Range: </label> <select id="range" placeholder=""> <option value="16">&PlusMinus;16&#x1D454;</option> <option value="8" selected>&PlusMinus;8&#x1D454;</option> <option value="4">&PlusMinus;4&#x1D454;</option> <option value="2">&PlusMinus;2&#x1D454;</option> </select> </div> <div><label for="metadata">Metadata: </label><input id="metadata" type="text" placeholder="(none)"></div> <div><label for="start">Start: </label><input id="start" type="datetime-local"></div> <div><label for="stop">Stop: </label><input id="stop" type="datetime-local"></div> </details> </fieldset> <div class="connected"> <div><input class="button" type="submit" value="Configure"></div> </div> <div class="disconnected"> <div><input class="button" id="add_device" type="button" value="Connect to device..."></div> </div> </form> <form class="connected"> <fieldset id="device-fieldset"> <legend>Device</legend> <div><label for="device-id">Id: </label><output id="device-id">-</output></div> <div><label for="battery">Battery: </label><meter id="battery-meter" min="0" max="100" low="30" high="85" optimum="100" value="0"></meter> <output id="battery">-</output></div> <div><label for="state">State: </label><output id="state">-</output></div> </fieldset> </form> </div> <output id="output">-</output> </body></html>